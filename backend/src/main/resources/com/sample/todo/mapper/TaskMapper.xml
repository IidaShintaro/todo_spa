<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sample.todo.mapper.TaskMapper">

    <!-- タスク一覧取得 -->
    <select id="findAll" resultType="TaskEntity">
        SELECT
            tt.id as id,
            tt.category_id as categoryId,
            cm.category_name as category,
            tt.task_name as task,
            tt.detail as detail,
            tt.status_id as statusId,
            sm.status_name as status,
            tt.deadline as deadline,
            tt.created_at as created_at,
            tt.updated_at as updated_at,
            tt.delete_flag as delete_flag
        FROM
            task_table tt
        LEFT JOIN
            category_master cm ON tt.category_id = cm.id
        LEFT JOIN
            status_master sm ON tt.status_id = sm.id
        WHERE
            tt.delete_flag = false
        ORDER BY
            tt.id ASC
    </select>

    <!-- 検索取得 -->
    <select id="searchTask" resultType="TaskEntity">
        SELECT
        tt.id as id,
        tt.category_id as categoryId,
        cm.category_name as category,
        tt.task_name as task,
        tt.detail as detail,
        tt.status_id as statusId,
        sm.status_name as status,
        tt.deadline as deadline,
        tt.created_at as created_at,
        tt.updated_at as updated_at,
        tt.delete_flag as delete_flag
        FROM
        task_table tt
        LEFT JOIN
        category_master cm ON tt.category_id = cm.id
        LEFT JOIN
        status_master sm ON tt.status_id = sm.id
        <where>
        tt.delete_flag = false
        <if test="categoryId != null and categoryId != ''">
            AND tt.category_id = #{categoryId}
        </if>
        <if test="statusId != null and statusId != ''">
            AND tt.status_id = #{statusId}
        </if>
        </where>
        ORDER BY
        tt.id ASC
    </select>

    <!-- タスク1件取得 -->
    <select id="findById" resultType="TaskEntity">
        SELECT
            tt.id as id,
            tt.category_id as categoryId,
            cm.category_name as category,
            tt.task_name as task,
            tt.detail as detail,
            tt.status_id as statusId,
            sm.status_name as status,
            tt.deadline as deadline,
            tt.created_at as created_at,
            tt.updated_at as updated_at,
            tt.delete_flag as delete_flag
        FROM
            task_table tt
        LEFT JOIN
            category_master cm ON tt.category_id = cm.id
        LEFT JOIN
            status_master sm ON tt.status_id = sm.id
        WHERE
            tt.id = #{id}
            AND tt.delete_flag = false
    </select>

    <!-- タスク更新 -->
    <update id="updateTask">
        UPDATE task_table
        SET
        category_id = #{todo.categoryId},
        detail = #{todo.detail},
        deadline = #{todo.deadline},
        status_id = #{todo.statusId}
        WHERE id = #{id}
    </update>

    <!-- タスク論理削除 -->
    <update id="deleteTask">
        UPDATE task_table
        SET
        delete_flag = true
        WHERE id = #{id}
    </update>

    <!-- タスク新規作成 -->
    <insert id="createTask">
        INSERT INTO task_table (
            category_id,
            task_name,
            detail,
            deadline,
            status_id
        ) VALUES (
            #{categoryId},
            #{task},
            #{detail},
            #{deadline},
            #{statusId}
        )
    </insert>

</mapper>